---
title: "Understanding `keras` in R"
subtitle: "NAVAR"
author:
- "Marc Agust√≠ (marc.agusti@barcelonagse.eu)"
- "Patrick Altmeyer (patrick.altmeyer@barcelonagse.eu)"
- "Ignacio Vidal-Quadras Costa (ignacio.vidalquadrascosta@barcelonagse.eu)"
date: "`r format(Sys.Date(), '%B, %Y')`"
output: 
  bookdown::html_document2: default
  github_document: default
  bookdown::pdf_document2: 
    toc: false
bibliography: "bib.bib"
link-citations: true
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, message=FALSE, eval=FALSE)
library(keras)
```

# Quick intro

Just quickly reproducing steps from this [intro](https://tensorflow.rstudio.com/tutorials/beginners/) to check that everything runs smoothly.

```{r}
mnist <- dataset_mnist()
mnist$train$x <- mnist$train$x/255
mnist$test$x <- mnist$test$x/255
```

Just composing a simple model:

```{r}
model <- keras_model_sequential() %>% 
  layer_flatten(input_shape = c(28, 28)) %>% 
  layer_dense(units = 128, activation = "relu") %>% 
  layer_dropout(0.2) %>% 
  layer_dense(10, activation = "softmax")
summary(model)
```

Compiling it - that is, defining loss, optimizer and (optionally) metrics:

```{r}
model %>% 
  compile(
    loss = "sparse_categorical_crossentropy",
    optimizer = "adam",
    metrics = "accuracy"
  )
```

And finally fitting it:

```{r}
model %>% 
  fit(
    x = mnist$train$x, y = mnist$train$y,
    epochs = 5,
    validation_split = 0.3,
    verbose = 2
  )
```

Finally, we can also easily access the model performance:

```{r}
model %>% 
  evaluate(mnist$test$x, mnist$test$y, verbose = 0)
```

This all seems to be working smoothly, even on AWS with a `t2.micro` instance and 2GB of swap memory.


