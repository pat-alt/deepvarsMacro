# Empirics

```{r}
library(fbi)
library(deepvars)
library(data.table)
```

Transform the data
```{r, echo = FALSE}
test <- fredmd("fredmd/2021-04.csv")
variables <- c("date", "X6", "X25", "X113", "X84")
variables_names <- c("date", "IP", "UR", "CPI", "FFR")
test <- test[3:nrow(test),variables]
colnames(test) <- variables_names
dt <- data.table(test)
var_cols = colnames(dt)[2:ncol(dt)]
```

Train test split
```{r}
train_test_split <- split_sample(dt)
train_data <- train_test_split$train_data
```


Select the number of lags

```{r}
lags <- VAR_lag_select(train_data[,.SD,.SDcols=var_cols])$p
```


```{r}
# VAR
var_model <- vareg(train_data, lags = lags)
# Deep VAR
deepvar_model <- deepvareg(train_data, lags=lags, num_units = 100, epochs=100, p_drop_out = 0.5)
```

Predictions in sample

```{r}
y_true <- var_model$y_train
```


VAR:

```{r}
pred_var <- predict(var_model)
plot(pred_var, y_true = y_true)
```
DeepVAR:
```{r}
pred_deepvar <- predict(deepvar_model)
plot(pred_deepvar, y_true = y_true)
```
Predictions out of sample

```{r}
X_test <- prepare_test_data(train_test_split, lags=lags)$X_test
y_test <- prepare_test_data(train_test_split, lags=lags)$y_test

```

VAR:
```{r}
pred_var <- predict(var_model, X=X_test)
plot(pred_var, y_true = y_test)
```
DeepVAR:
```{r}
pred_dvar <- predict(deepvar_model, X=X_test)
plot(pred_dvar, y_true = y_test)
```


Comulative loss:

Cumulative loss in-sample

```{r}
cum_loss_var <- cum_loss(var_model)$cum_loss[,type:="var"]
cum_loss_dvar <- cum_loss(deepvar_model)$cum_loss[,type:="deepvar"]
dt_plot <- rbind(cum_loss_dvar, cum_loss_var)
ggplot2::ggplot(data=dt_plot, ggplot2::aes(x=date, y=value, colour=type)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~variable, scales = "free_y") +
  ggplot2::scale_color_discrete(name="Model:") +
  ggplot2::labs(
      x="Date",
      y="Squared error"
    )
```

Cumulative loss out-of-sample

```{r}
cum_loss_var <- cum_loss(var_model)$cum_loss[,type:="var"]
cum_loss_dvar <- cum_loss(deepvar_model)$cum_loss[,type:="deepvar"]
dt_plot <- rbind(cum_loss_dvar, cum_loss_var)
ggplot2::ggplot(data=dt_plot, ggplot2::aes(x=date, y=value, colour=type)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~variable, scales = "free_y") +
  ggplot2::scale_color_discrete(name="Model:") +
  ggplot2::labs(
      x="Date",
      y="Squared error"
    )
```

RMSE:

```{r}
rmse_var <- rbind(
  rmse(var_model)[,model:="var"][,sample:="train"],
  rmse(var_model, X=X_test, y=y_test)[,model:="var"][,sample:="test"]
)
rmse_dvar <- rbind(
  rmse(deepvar_model)[,model:="deepvar"][,sample:="train"],
  rmse(deepvar_model, X=X_test, y=y_test)[,model:="deepvar"][,sample:="test"]
)
tab_rmse <- rbind(rmse_var, rmse_dvar)
tab_rmse <- data.table::dcast(tab_rmse, sample + variable ~ model, value.var = "value")
tab_rmse[, ratio:= deepvar/var]
knitr::kable(tab_rmse, 
  col.names = c("Sample", "Variable", "DVAR", "VAR", "Ratio"),
  digits = 5) 
```

Forecasts

VAR:
```{r}
fcst_var <- forecast(var_model, n.ahead = 50)
plot(fcst_var)
```

DeepVAR:
```{r}
fcst_dvar <- forecast(deepvar_model, n.ahead = 50)
plot(fcst_dvar)
```


